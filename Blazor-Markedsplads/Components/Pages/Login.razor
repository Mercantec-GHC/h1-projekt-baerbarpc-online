@page "/login"
@using System.ComponentModel.DataAnnotations
@using BlazorMarkedsplads.Models
@using BlazorMarkedsplads.Services
@using BCrypt.Net;
@inject IUserRepository UserRepo
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Log ind</PageTitle>

<section class="py-5" style="background-color:#f0f0f0; min-height:65vh;">
    <div class="container d-flex justify-content-center">
        <div class="card shadow-sm border-0" style="max-width:520px; width:100%;">
            <div class="card-body p-4 p-md-5">
                <h4 class="fw-bold">Log ind</h4>
                <p class="small text-muted mb-4">Indtast dine oplysninger for at tilgå din konto</p>

                @if (!string.IsNullOrWhiteSpace(formError))
                {
                    <div class="alert alert-danger">@formError</div>
                }

                <EditForm Model="loginModel" OnValidSubmit="HandleValidSubmit" FormName="LoginForm">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">Email *</label>
                        <InputText class="form-control"
                                   type="email"
                                   @bind-Value="loginModel.Email"
                                   placeholder="Indtast din email" />
                        <ValidationMessage For="@(() => loginModel.Email)" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold">Adgangskode *</label>
                        <InputText class="form-control"
                                   type="password"
                                   @bind-Value="loginModel.Password" />
                        <ValidationMessage For="@(() => loginModel.Password)" class="text-danger small" />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        Log ind
                    </button>

                    <p class="text-center small mb-0">
                        Har du ikke en konto? <a href="/CreateUser">Opret en her</a>
                    </p>
                </EditForm>
            </div>
        </div>
    </div>
</section>

@code {
    [Inject]
    private UserStateService UserState { get; set; } = default!;

    private LoginModel loginModel = new();
    private string? formError;

    private async Task HandleValidSubmit()
    {
        formError = null;

        try
        {
            var user = await UserRepo.GetByEmailAsync(loginModel.Email);

            if (user != null && BCrypt.Verify(loginModel.Password, user.Password))
            {
                // Gem bruger-ID i browseren for at "huske" login efter en F5-refresh
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "uid", user.Id.ToString());

                // *** NYT: Fortæl vores state service, at brugeren er logget ind ***
                UserState.Login(user.Id);

                // Naviger til brugerens profilside
                NavManager.NavigateTo("/UserProfile"); 
            }
            else
            {
                formError = "Ugyldig email eller adgangskode.";
            }
        }
        catch (Exception ex)
        {
            formError = $"Der opstod en fejl: {ex.Message}";
        }
    }

    /// <summary>
    /// A nested class to hold the form data for the login page.
    /// </summary>
    private class LoginModel
    {
        [Required(ErrorMessage = "Email er påkrævet")]
        [EmailAddress(ErrorMessage = "Indtast venligst en gyldig email-adresse")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Adgangskode er påkrævet")]
        public string Password { get; set; } = string.Empty;
    }
}