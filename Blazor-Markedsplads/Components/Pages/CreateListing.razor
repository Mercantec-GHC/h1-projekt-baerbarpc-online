@page "/CreateListing"
@inject NavigationManager NavManager
@inject IListingRepository ListingRepo
@rendermode InteractiveServer

<PageTitle>Opret Annonce</PageTitle>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center gap-1" href="/">
            <i class="bi bi-laptop"></i> LaptopMarket
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center gap-lg-3">
                <li class="nav-item">
                    <NavLink class="nav-link" href="/" ActiveClass="active">Forside</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/ListingsPage" ActiveClass="active">Annoncer</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/CreateListing" ActiveClass="active">Opret Annonce</NavLink>
                </li>
            </ul>
        </div>
    </div>
</nav>

<section class="py-5" style="background-color:#f8f9fa; min-height:70vh;">
    <div class="container d-flex justify-content-center">
        <div class="card shadow-sm border-0" style="max-width: 650px; width:100%;">
            <div class="card-body p-4 p-md-5">
                <h4 class="fw-bold">Opret Annonce</h4>
                <p class="text-muted mb-4">Udfyld oplysninger om din bærbare computer</p>

                @* Vis generel fejlbesked *@
                @if (!string.IsNullOrWhiteSpace(formError))
                {
                    <div class="alert alert-danger">@formError</div>
                }

                <EditForm Model="createModel"
                          OnValidSubmit="HandleSubmitValid"
                          FormName="createListingForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-3">
                        <!-- 1) Titel -->
                        <div class="col-12">
                            <label for="title" class="form-label fw-semibold">Overskrift</label>
                            <InputText id="title" class="form-control"
                                       @bind-Value="createModel.Title"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- 2) Brand / Model -->
                        <div class="col-md-6">
                            <label for="brand" class="form-label fw-semibold">Mærke</label>
                            <InputText id="brand" class="form-control"
                                       @bind-Value="createModel.Brand"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="model" class="form-label fw-semibold">Model</label>
                            <InputText id="model" class="form-control"
                                       @bind-Value="createModel.Model"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- 3) CPU / GPU -->
                        <div class="col-md-6">
                            <label for="cpu" class="form-label fw-semibold">CPU</label>
                            <InputText id="cpu" class="form-control"
                                       @bind-Value="createModel.CPU"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="gpu" class="form-label fw-semibold">GPU</label>
                            <InputText id="gpu" class="form-control"
                                       @bind-Value="createModel.GPU"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- 4) RAM / Storage -->
                        <div class="col-md-4">
                            <label for="ram" class="form-label fw-semibold">RAM (GB)</label>
                            <InputNumber id="ram" class="form-control"
                                         @bind-Value="createModel.RAM" />
                        </div>
                        <div class="col-md-4">
                            <label for="storage" class="form-label fw-semibold">Lager (GB)</label>
                            <InputNumber id="storage" class="form-control"
                                         @bind-Value="createModel.Storage" />
                        </div>

                        <!-- 5) Skærmstørrelse -->
                        <div class="col-md-4">
                            <label for="screenSize" class="form-label fw-semibold">Skærm (")</label>
                            <InputText id="screenSize" class="form-control"
                                       @bind-Value="createModel.ScreenSize"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- 6) OS / Condition -->
                        <div class="col-md-6">
                            <label for="os" class="form-label fw-semibold">Styresystem</label>
                            <InputText id="os" class="form-control"
                                       @bind-Value="createModel.OS"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="condition" class="form-label fw-semibold">Tilstand</label>
                            <InputSelect id="condition" class="form-select"
                                         @bind-Value="createModel.Condition">
                                <option value="">– vælg –</option>
                                <option>Næsten ny</option>
                                <option>Let brugt</option>
                                <option>Brugt</option>
                                <option>Slidt</option>
                            </InputSelect>
                        </div>

                        <!-- 7) Pris (kr.) -->
                        <div class="col-md-6">
                            <label for="price" class="form-label fw-semibold">Pris (kr.)</label>
                            <InputNumber id="price" class="form-control"
                                         @bind-Value="createModel.Price" />
                        </div>

                        <!-- 8) Telefon / Lokation -->
                        <div class="col-md-6">
                            <label for="phone" class="form-label fw-semibold">Telefon</label>
                            <InputText id="phone" class="form-control"
                                       @bind-Value="createModel.Phone"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="location" class="form-label fw-semibold">Lokation</label>
                            <InputText id="location" class="form-control"
                                       @bind-Value="createModel.Location"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- 9) Beskrivelse -->
                        <div class="col-12">
                            <label for="description" class="form-label fw-semibold">Beskrivelse</label>
                            <InputTextArea id="description" class="form-control"
                                           @bind-Value="createModel.Description"
                                           @bind-Value:event="oninput"
                                           rows="4" />
                        </div>

                        <!-- 10) Vilkår og betingelser -->
                        <div class="col-12 form-check mt-2">
                            <InputCheckbox id="acceptTerms" class="form-check-input"
                                           @bind-Value="createModel.AcceptTerms" />
                            <label for="acceptTerms" class="form-check-label">
                                Jeg accepterer vilkår &amp; betingelser
                            </label>
                        </div>
                    </div>

                    <!-- 11) Submit / Fortryd -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            Opret annonce
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                            Fortryd
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</section>

@code {
    private CreateListingViewModel createModel = new CreateListingViewModel();
    private string? formError;

    private async Task HandleSubmitValid()
    {
        // 1) Byg Listing-objekt – coalesce alle mulige string-felter til tom streng:
        var listing = new Listing
            {
                Brand = createModel.Brand ?? string.Empty,
                Model = createModel.Model ?? string.Empty,
                Gpu = createModel.GPU ?? string.Empty,
                Cpu = createModel.CPU ?? string.Empty,
                Ram = createModel.RAM,
                Storage = createModel.Storage,
                OS = createModel.OS ?? string.Empty,
                Price = createModel.Price.ToString(),
                ScreenSize = createModel.ScreenSize ?? string.Empty,
                Condition = createModel.Condition ?? string.Empty,

                Title = createModel.Title ?? string.Empty,
                Description = createModel.Description ?? string.Empty,
                Phone = createModel.Phone ?? string.Empty,
                Location = createModel.Location ?? string.Empty,
                CreatedUtc = DateTime.UtcNow
            };

        int newId;
        try
        {
            // 2) Indsæt i databasen – returnerer det oprettede Listing-id:
            newId = await ListingRepo.InsertAsync(listing);
        }
        catch (Exception ex)
        {
            // Hvis indsættelse fejler, vis fejl til brugeren:
            formError = $"Kunne ikke oprette annonce: {ex.Message}";
            return;
        }

        // 3) Hvis vi kommer hertil, var indsættelsen i databasen en succes.
        //    Naviger direkte til detalje-siden for det nye id.
        //
        //    Bemærk: Denne navigation ligger *uden* for try/catch, så
        //    vi ikke “fanger” en NavigationException som formError.
        //    Hvis du af en eller anden grund stadig får en NavigationException,
        //    kan du i stedet skrive:
        //       NavManager.NavigateTo($"/ListingsDetailsPage/{newId}", forceLoad: true);
        //
        NavManager.NavigateTo($"/ListingsDetailsPage/{newId}");
    }

    private void Cancel()
    {
        NavManager.NavigateTo("/ListingsPage", forceLoad: true);
    }
}
