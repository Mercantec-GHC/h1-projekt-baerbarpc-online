@page "/CreateListing"
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavManager
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Opret Annonce</PageTitle>

<!-- =========  Top Navigation (identisk med HomePage1) ========= -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center gap-1" href="/">
            <i class="bi bi-laptop"></i> LaptopMarket
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center gap-lg-3">
                <li class="nav-item"><NavLink class="nav-link" href="/" ActiveClass="active">Forside</NavLink></li>
                <li class="nav-item"><NavLink class="nav-link" href="/ListingsPage" ActiveClass="active">Annoncer</NavLink></li>
                <li class="nav-item"><NavLink class="nav-link" href="/profile" ActiveClass="active">Konto</NavLink></li>

                <!-- Brug initialer / avatar som i andre sider -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                       href="#" data-bs-toggle="dropdown" style="width:36px;height:36px;">JD</a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><NavLink class="dropdown-item" href="/profile">Profil</NavLink></li>
                        <li><button class="dropdown-item" @onclick="Logout">Log ud</button></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav> <!-- :contentReference[oaicite:0]{index=0} -->

<!-- =========  Formular-kortet ========= -->
<section class="py-5" style="background-color:#f8f9fa; min-height:70vh;">
    <div class="container d-flex justify-content-center">
        <div class="card shadow-sm border-0" style="max-width: 650px; width:100%;">
            <div class="card-body p-4 p-md-5">
                <h4 class="fw-bold">Opret Annonce</h4>
                <p class="text-muted mb-4">Udfyld nedenstående oplysninger om din bærbare computer</p>

                <EditForm Model="listing" OnValidSubmit="HandleValidSubmit" enctype="multipart/form-data">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- =====  Billed-upload  ===== -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Billeder af din bærbare</label>
                        <InputFile OnChange="HandleFiles" multiple accept=".png,.jpg,.jpeg"
                                   class="border border-secondary-subtle rounded text-center w-100 py-5"
                                   style="cursor:pointer;">
                        </InputFile>
                        <small class="d-block text-muted mt-1">PNG, JPG op til 10 MB (maks 5 billeder)</small>
                        @if (imageErrors.Any())
                        {
                            <ul class="text-danger small ps-3">
                                @foreach (var err in imageErrors) { <li>@err</li>; }
                            </ul>
                        }
                    </div>

                    <!-- =====  Grundlæggende info  ===== -->
                    <h6 class="fw-bold mt-4">Grundlæggende Information</h6>
                    <div class="row g-3">
                        <div class="col-12">
                            <InputText class="form-control" @bind-Value="listing.Title"
                                       placeholder='Titel på annonce (f.eks. "MacBook Pro 16 2023 – M2 Max")' />
                            <ValidationMessage For="() => listing.Title" />
                        </div>

                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.Brand">
                                <option value="">Vælg mærke</option>
                                @foreach (var brand in Brands) { <option value="@brand">@brand</option>; }
                            </InputSelect>
                            <ValidationMessage For="() => listing.Brand" />
                        </div>

                        <div class="col-md-6">
                            <InputText class="form-control" @bind-Value="listing.Model"
                                       placeholder='Model (f.eks. "MacBook Pro 16")' />
                        </div>
                    </div>

                    <!-- =====  Tekniske specs  ===== -->
                    <h6 class="fw-bold mt-4">Tekniske Specifikationer</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.CPU">
                                <option value="">Vælg processor</option>
                                @foreach (var cpu in CPUs) { <option value="@cpu">@cpu</option>; }
                            </InputSelect>
                        </div>

                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.RAM">
                                <option value="">Vælg RAM størrelse</option>
                                @foreach (var ram in Rams) { <option value="@ram">@ram</option>; }
                            </InputSelect>
                        </div>

                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.Storage">
                                <option value="">Vælg lagerplads</option>
                                @foreach (var s in Storages) { <option value="@s">@s</option>; }
                            </InputSelect>
                        </div>

                        <div class="col-md-6">
                            <InputText class="form-control" @bind-Value="listing.GPU"
                                       placeholder="Grafikkort (f.eks. M2 Max 38-core GPU)" />
                        </div>

                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.ScreenSize">
                                <option value="">Vælg skærmstørrelse</option>
                                @foreach (var size in ScreenSizes) { <option value="@size">@size</option>; }
                            </InputSelect>
                        </div>

                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.OS">
                                <option value="">Vælg operativsystem</option>
                                @foreach (var os in OperatingSystems) { <option value="@os">@os</option>; }
                            </InputSelect>
                        </div>
                    </div>

                    <!-- =====  Tilstand & pris  ===== -->
                    <h6 class="fw-bold mt-4">Tilstand og Pris</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <InputSelect class="form-select" @bind-Value="listing.Condition">
                                <option value="">Vælg tilstand</option>
                                @foreach (var cond in Conditions) { <option value="@cond">@cond</option>; }
                            </InputSelect>
                            <ValidationMessage For="() => listing.Condition" />
                        </div>

                        <div class="col-md-6">
                            <InputNumber class="form-control" @bind-Value="listing.Price"
                                         placeholder="Pris (DKK)" />
                            <ValidationMessage For="() => listing.Price" />
                        </div>

                        <div class="col-12">
                            <InputTextarea class="form-control" rows="4" bind-Value="listing.Description"
                                           placeholder="Beskriv din bærbare computer i detaljer …" />
                        </div>
                    </div>

                    <!-- =====  Kontakt  ===== -->
                    <h6 class="fw-bold mt-4">Kontaktinformation</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <InputText class="form-control" @bind-Value="listing.Phone"
                                       placeholder="Telefonnummer" />
                            <ValidationMessage For="() => listing.Phone" />
                        </div>

                        <div class="col-md-6">
                            <InputText class="form-control" @bind-Value="listing.Location"
                                       placeholder="By eller postnummer" />
                        </div>
                    </div>

                    <!-- =====  Vilkår  ===== -->
                    <div class="form-check mt-3">
                        <InputCheckbox class="form-check-input" @bind-Value="listing.AcceptTerms" />
                        <label class="form-check-label small">
                            Jeg accepterer vilkår og betingelser for oprettelse af annoncer
                        </label>
                        <ValidationMessage For="() => listing.AcceptTerms" />
                    </div>

                    <!-- =====  Knapper  ===== -->
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">Annuller</button>
                        <button type="button" class="btn btn-outline-primary" @onclick="Preview">Forhåndsvis</button>
                        <button type="submit" class="btn btn-primary" disabled="@( !listing.AcceptTerms )">
                            Opret Annonce
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</section>

<!-- =========  Footer (identisk med HomePage1) ========= -->
<footer class="footer bg-dark text-white pt-5">
    <div class="container">
        <div class="row gy-4">
            <div class="col-md-4">
                <h5 class="fw-bold d-flex align-items-center gap-1 mb-3">
                    <i class="bi bi-laptop"></i> LaptopMarket
                </h5>
                <p class="small opacity-75">Det bedste sted at købe og sælge bærbare computere online.</p>
            </div>

            <div class="col-md-4">
                <h5 class="fw-bold mb-3">Hurtige Links</h5>
                <ul class="list-unstyled small">
                    <li><a href="/about" class="text-white text-decoration-none">Om Os</a></li>
                    <li><a href="/terms" class="text-white text-decoration-none">Vilkår & Betingelser</a></li>
                    <li><a href="/privacy" class="text-white text-decoration-none">Privatlivspolitik</a></li>
                    <li><a href="/contact" class="text-white text-decoration-none">Kontakt Os</a></li>
                </ul>
            </div>

            <div class="col-md-4">
                <h5 class="fw-bold mb-3">Følg Os</h5>
                <div class="d-flex gap-2">
                    <a href="#" class="btn btn-outline-light btn-sm rounded-circle"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="btn btn-outline-light btn-sm rounded-circle"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="btn btn-outline-light btn-sm rounded-circle"><i class="bi bi-instagram"></i></a>
                </div>
            </div>
        </div>
        <hr class="border-secondary my-4" />
        <p class="text-center small opacity-75 mb-0">&copy; @DateTime.Now.Year LaptopMarket. Alle rettigheder forbeholdes.</p>
    </div>
</footer> <!-- :contentReference[oaicite:1]{index=1} -->

@code {
    /* ------------  Data-model ------------ */
    private readonly ListingModel listing = new();

    /* ------------  Dropdown-data ------------ */
    private static readonly string[] Brands          = { "Apple", "Dell", "Lenovo", "HP", "Asus", "Acer", "MSI" };
    private static readonly string[] CPUs            = { "Apple M-serie", "Intel Core i7", "Intel Core i9", "AMD Ryzen 7", "AMD Ryzen 9" };
    private static readonly string[] Rams            = { "8 GB", "16 GB", "32 GB", "64 GB" };
    private static readonly string[] Storages        = { "256 GB SSD", "512 GB SSD", "1 TB SSD", "2 TB SSD" };
    private static readonly string[] ScreenSizes     = { "13″", "14″", "15″", "16″", "17″" };
    private static readonly string[] OperatingSystems= { "macOS", "Windows 11", "Windows 10", "Linux" };
    private static readonly string[] Conditions      = { "Ny", "Som ny", "Meget god", "God", "Brugt" };

    /* ------------  Billed-upload håndtering ------------ */
    private readonly List<IBrowserFile> images = new();
    private readonly List<string> imageErrors = new();

    private void HandleFiles(InputFileChangeEventArgs e)
    {
        imageErrors.Clear();
        images.Clear();

        foreach (var file in e.GetMultipleFiles(5))
        {
            if (file.Size > 10 * 1024 * 1024)
            {
                imageErrors.Add($"{file.Name} er større end 10 MB.");
                continue;
            }
            if (!(file.ContentType is "image/png" or "image/jpeg"))
            {
                imageErrors.Add($"{file.Name} er ikke PNG/JPG.");
                continue;
            }
            images.Add(file);
        }
    }

    /* ------------  Knap-handlers ------------ */
    private void HandleValidSubmit()
    {
        Console.WriteLine($"[LISTING] Gemmer annonce '{listing.Title}' med {images.Count} billeder");

        // TODO: 1) Upload billeder (fx til blob-storage) og få URLs
        //       2) Kald DBService.InsertProductModelAsync(listing, imageUrls);

        NavManager.NavigateTo("/ListingsPage");
    }

    private void Cancel()   => NavManager.NavigateTo("/");
    private void Preview()  => Console.WriteLine("[LISTING] Forhåndsvisning …");
    private void Logout()   => NavManager.NavigateTo("/login", forceLoad: true);

    /* ------------  Model-klasser ------------ */
    private class ListingModel
    {
        [Required(ErrorMessage = "Titel er påkrævet")]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "Mærke er påkrævet")]
        public string Brand { get; set; } = string.Empty;

        public string Model          { get; set; } = string.Empty;
        public string CPU            { get; set; } = string.Empty;
        public string RAM            { get; set; } = string.Empty;
        public string Storage        { get; set; } = string.Empty;
        public string GPU            { get; set; } = string.Empty;
        public string ScreenSize     { get; set; } = string.Empty;
        public string OS             { get; set; } = string.Empty;

        [Required(ErrorMessage = "Tilstand er påkrævet")]
        public string Condition { get; set; } = string.Empty;

        [Required(ErrorMessage = "Pris er påkrævet")]
        [Range(1, 1_000_000, ErrorMessage = "Pris skal være positiv")]
        public decimal? Price { get; set; }

        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Telefonnummer er påkrævet")]
        public string Phone { get; set; } = string.Empty;

        public string Location   { get; set; } = string.Empty;

        [Range(typeof(bool), "true", "true", ErrorMessage = "Du skal acceptere vilkår og betingelser")]
        public bool AcceptTerms  { get; set; }
    }
}