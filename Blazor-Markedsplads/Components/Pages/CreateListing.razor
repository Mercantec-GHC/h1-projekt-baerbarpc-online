@page "/CreateListing"
@inject NavigationManager NavManager
@inject IListingRepository ListingRepo
@inject IHttpContextAccessor HttpContextAccessor
@using Blazor_Markedsplads.Models
@using Microsoft.AspNetCore.Components.Forms


<PageTitle>Opret Annonce</PageTitle>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <!-- … din navbar … -->
</nav>

<section class="py-5" style="background-color:#f8f9fa; min-height:70vh;">
    <div class="container d-flex justify-content-center">
        <div class="card shadow-sm border-0" style="max-width: 650px; width:100%;">
            <div class="card-body p-4 p-md-5">
                <h4 class="fw-bold">Opret Annonce</h4>
                <p class="text-muted mb-4">Udfyld oplysninger om din bærbare computer</p>

                @if (!string.IsNullOrWhiteSpace(formError))
                {
                    <div class="alert alert-danger">@formError</div>
                }

                <EditForm Model="createModel"
                          OnValidSubmit="HandleSubmit"
                          FormName="CreateListingForm">
                    <DataAnnotationsValidator />
                    <div class="row g-3">
                        <!-- Overskrift -->
                        <div class="col-12">
                            <label for="title" class="form-label fw-semibold">Overskrift</label>
                            <InputText id="title" class="form-control"
                                       @bind-Value="createModel.Title"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- Mærke / Model -->
                        <div class="col-md-6">
                            <label for="brand" class="form-label fw-semibold">Mærke</label>
                            <InputText id="brand" class="form-control"
                                       @bind-Value="createModel.Brand"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="model" class="form-label fw-semibold">Model</label>
                            <InputText id="model" class="form-control"
                                       @bind-Value="createModel.Model"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- CPU / GPU -->
                        <div class="col-md-6">
                            <label for="cpu" class="form-label fw-semibold">CPU</label>
                            <InputText id="cpu" class="form-control"
                                       @bind-Value="createModel.Cpu"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="gpu" class="form-label fw-semibold">GPU</label>
                            <InputText id="gpu" class="form-control"
                                       @bind-Value="createModel.Gpu"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- RAM / Storage -->
                        <div class="col-md-4">
                            <label for="ram" class="form-label fw-semibold">RAM (GB)</label>
                            <InputNumber id="ram" class="form-control"
                                         @bind-Value="createModel.Ram" />
                        </div>
                        <div class="col-md-4">
                            <label for="storage" class="form-label fw-semibold">Lager (GB)</label>
                            <InputNumber id="storage" class="form-control"
                                         @bind-Value="createModel.Storage" />
                        </div>

                        <!-- Skærmstørrelse -->
                        <div class="col-md-4">
                            <label for="screenSize" class="form-label fw-semibold">Skærm (")</label>
                            <InputText id="screenSize" class="form-control"
                                       @bind-Value="createModel.ScreenSize"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- Styresystem / Tilstand -->
                        <div class="col-md-6">
                            <label for="os" class="form-label fw-semibold">Styresystem</label>
                            <InputText id="os" class="form-control"
                                       @bind-Value="createModel.OS"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-6">
                            <label for="condition" class="form-label fw-semibold">Tilstand</label>
                            <InputSelect id="condition" class="form-select"
                                         @bind-Value="createModel.Condition">
                                <option value="">– vælg –</option>
                                <option>Næsten ny</option>
                                <option>Let brugt</option>
                                <option>Brugt</option>
                                <option>Slidt</option>
                            </InputSelect>
                        </div>

                        <!-- Pris / Telefon -->
                        <div class="col-md-6">
                            <label for="price" class="form-label fw-semibold">Pris (kr.)</label>
                            <InputNumber id="price" class="form-control"
                                         @bind-Value="createModel.Price" />
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label fw-semibold">Telefon</label>
                            <InputText id="phone" class="form-control"
                                       @bind-Value="createModel.Phone"
                                       @bind-Value:event="oninput" />
                        </div>

                        <!-- Lokation / Beskrivelse -->
                        <div class="col-md-12">
                            <label for="location" class="form-label fw-semibold">Lokation</label>
                            <InputText id="location" class="form-control"
                                       @bind-Value="createModel.Location"
                                       @bind-Value:event="oninput" />
                        </div>
                        <div class="col-md-12">
                            <label for="description" class="form-label fw-semibold">Beskrivelse</label>
                            <InputTextArea id="description" class="form-control"
                                           @bind-Value="createModel.Description"
                                           @bind-Value:event="oninput"
                                           rows="4" />
                        </div>

                        <!-- Vilkår og betingelser (checkbox) -->
                        <div class="col-md-12 form-check mt-2">
                            <InputCheckbox id="acceptTerms"
                                           class="form-check-input"
                                           @bind-Value="createModel.AcceptTerms" />
                            <label for="acceptTerms" class="form-check-label">
                                Jeg accepterer vilkår &amp; betingelser
                            </label>

                            <p class="small">AcceptTerms (debug): <strong>@createModel.AcceptTerms</strong></p>
                        </div>
                    </div>

                    <!-- Knapper -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            Opret annonce
                        </button>
                        <button type="button" class="btn btn-outline-secondary">
                            Fortryd
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</section>

@code {
    [SupplyParameterFromForm]
    private Listing createModel { get; set; } = new();
    private string? formError;


    private void Cancel()
    {

        NavManager.NavigateTo("/");
    }

    private async Task HandleSubmit()
    {

        formError = null;
        Console.WriteLine("[DEBUG] HandleSubmit entered.");


        if (!createModel.AcceptTerms)
        {
            formError = "Du skal acceptere vilkår og betingelser.";
            Console.WriteLine("[DEBUG] AcceptTerms not checked.");
            return;
        }

        createModel.CreatedUtc = DateTime.UtcNow;

        var listing = new Listing
            {
                Brand = createModel.Brand?.Trim() ?? string.Empty,
                Model = createModel.Model?.Trim() ?? string.Empty,
                Gpu = createModel.Gpu?.Trim() ?? string.Empty,
                Cpu = createModel.Cpu?.Trim() ?? string.Empty,
                Ram = createModel.Ram,
                Storage = createModel.Storage,
                OS = createModel.OS?.Trim() ?? string.Empty,
                Price = createModel.Price,
                ScreenSize = createModel.ScreenSize?.Trim() ?? string.Empty,
                Condition = createModel.Condition?.Trim() ?? string.Empty,
                Title = createModel.Title?.Trim() ?? string.Empty,
                Description = createModel.Description?.Trim() ?? string.Empty,
                Phone = createModel.Phone?.Trim() ?? string.Empty,
                Location = createModel.Location?.Trim() ?? string.Empty,
                CreatedUtc = createModel.CreatedUtc
            };
        Console.WriteLine("[DEBUG] Listing object created.");

        try
        {
            Console.WriteLine("[DEBUG] Attempting to insert listing into database...");
            int newId = await ListingRepo.InsertAsync(listing);
            Console.WriteLine($"[SUCCESS] Listing created with ID: {newId}. Attempting to navigate to /ListingPage with forceLoad: true.");

            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext != null)
            {
                if (!httpContext.Response.HasStarted)
                {
                    httpContext.Response.Redirect("/ListingPage");
                    return;
                }
                else
                {
                    formError = "Annoncen blev oprettet, men automatisk viderestilling fejlede (Response already started). Naviger venligst manuelt.";
                    Console.WriteLine("[ERROR] Could not perform HTTP redirect: Response has already started.");
                }
            }
            else
            {
                formError = "Annoncen blev oprettet, men automatisk viderestilling fejlede (HttpContext not available). Naviger venligst manuelt."; 
                Console.WriteLine("[ERROR] Could not perform HTTP redirect: HttpContext is null.");

            }

        }
        catch (Exception ex)
        {

            formError = $"Fejl under oprettelse eller navigation: {ex.Message}"; 
            Console.WriteLine($"[ERROR] CreateListing.HandleSubmit: {ex.ToString()}");

        }
        Console.WriteLine("[DEBUG] HandleSubmit finished.");

    }

}
